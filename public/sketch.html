<html lang="en-US">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
    <link rel="stylesheet" href="styles/sketch.css">
    <title>Artist 9000</title>
  </head>
  <body>
    <div class="container">
      <div class="slider">
        <span id="slidertext">Accuracy is at 25%</span>
        <input id="rangeslider" type="range" min="1" max="100" value="25">
      </div>
      <div class="title">Draw This: <span id="prompt"></span></div>
      <div id="game">
        <div id="canvas"></div>
        <div id="tools">
          <button id="clearScreen" onclick="clearScreen()"><img src="resources/clear.png"></button>
          <button id="eraser" onclick="equipEraser()"><img src="resources/eraser2.png"></button>
          <button id="pen" onclick="equipPencil()"><img src="resources/pencil2.png"></button>
          <input id="paint" type="color" value="#000000">
        </div>
      </div>
      <div id="submit2">
        <button id="newPrompt" class="submit" onclick="newPrompt()">New prompt</button>
        <button id="saveDrawing" class="submit" onclick="saveDrawing(givenPrompt)">Download</button>
        <button id="submit" class="submit">Computer Guess</button>
      </div>
    </div>
    <div id="loading" class="hide">Processing Image</div>
    <div id="note">Note: If you resize the page, you must reload the page for the canvas to be resized</div>
    <script src="https://cdn.jsdelivr.net/npm/p5@1.4.1/lib/p5.js"></script>
    <script src="javascript/jsonitems.js"></script>
    <script src="javascript/heap.js"></script>
    <script src="javascript/sketch.js"></script>
    <script src="javascript/logic.js"></script>
    <script>

      let givenPrompt = getPrompt();
      let accuracyValue = null
      let slider = document.getElementById("rangeslider")
      let sliderText = document.getElementById('slidertext')
      sliderText.innerText = 'Accuracy is at ' + slider.value + '%'
      slider.oninput = function() {
        sliderText.innerText = 'Accuracy is at ' + slider.value + '%'
        accuracyValue = slider.value
        console.log(accuracyValue)
      }
      //when the paint input button is pressed, update the values in the interface
      document.getElementById("paint").oninput = function () {
        let r = parseInt(this.value.substring(1, 3), 16);
        let g = parseInt(this.value.substring(3, 5), 16);
        let b = parseInt(this.value.substring(5, 7), 16);
        changeColor(r, g, b);
      }

      let startOfPrompt = 0;
      for (let i = 0; i < completeDataset.length; i++) {
        if (JSON.parse(completeDataset[i]).word === givenPrompt){
          startOfPrompt = i;
          break;
        }
      }

      //when the submit button is pressed, run the algorithm and go to the results page to display them
      document.getElementById("submit").onclick = function () {
        //first add the URL to the canvas as a png to the session storage, so that it can be in the html on results page
        let canvas = document.getElementById("defaultCanvas0");
        let ctx = canvas.getContext('2d')
        sessionStorage.setItem("canvasURL", canvas.toDataURL("img/png"));

        let strokes2 = getStrokes();

        //round up/down each coordinate to make it easier to compare to the dataset (whole integers)
        for (let stroke2 of strokes2){
          for (let i = 0; i < stroke2[0].length; i++){
            stroke2[0][i] = Math.floor(stroke2[0][i]);
            stroke2[1][i] = Math.floor(stroke2[1][i]);
          }
        }
        
        let bounds = getBoundingBox(strokes2);
        let xmin = bounds[0];
        let xmax = bounds[2];
        let ymin = bounds[1];
        let ymax = bounds[3];

        //scaled down to a 255x255 box
        let strokes3 = getStrokes();
        let ratio = 255 / (xmax - xmin);
        for (let stroke3 of strokes3){
          for (let i = 0; i < stroke3[0].length; i++){
            stroke3[0][i] = (Math.floor(stroke3[0][i]) - xmin) * ratio;
            stroke3[1][i] = (Math.floor(stroke3[1][i]) - ymin) * ratio;

          }
        }

        // RUN THE BIG SCARY ALGORITHM HERE AND GET A HEAP
        let sorted = compare(strokes3, ctx);
        
        //add to sessionStorage
        for (let i = 1; i <= prompts.length; i++){
          sessionStorage.setItem("prompt" + i.toString(), sorted[i - 1][0]);
          sessionStorage.setItem("similarity" + i.toString(), sorted[i - 1][1]);
        }

        window.location.href = 'results.html';
      }

      function mousePress (pressing) {
        if (pressing){
          startStroke();
        } else {
          endStroke();
        }
      }

      function mouseDown(){
        mousePress(true);
      }
      function mouseUp(){
        mousePress(false);
      }
      
      window.addEventListener("mousedown", mouseDown);
      window.addEventListener("mouseup", mouseUp);

      function newPrompt(){
        sessionStorage.removeItem("prompt");
        givenPrompt = getPrompt();
      }
      
      function getPrompt(){
        //get a randomized prompt (if one doesnt exist already) and add it to session storage in case the page is reloaded
        let givenPrompt = sessionStorage.getItem("prompt");
        if (givenPrompt == null){
          givenPrompt = prompts[Math.floor(Math.random() * prompts.length)];
          sessionStorage.setItem("prompt", givenPrompt);
        }

        //update the title so the user knows what the prompt is
        document.getElementById("prompt").innerText = givenPrompt;

        return givenPrompt;
      }
    </script>
  </body>
</html>